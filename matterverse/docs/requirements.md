# Matterverse 要件定義書（クラス設計前提）

## 1. システム概要
Matterverseは、Matterプロトコル対応デバイスの管理・制御・監視を行うサーバーアプリケーションです。デバイス情報の取得、MQTTによる外部連携、WebSocketによるリアルタイム通信をサポートします。

---

## 2. 機能要件

### 2.1 デバイス管理
- Matterデバイスの登録・削除・一覧取得ができること
- デバイス情報（NodeID, Endpoint, DeviceType, UniqueID, TopicIDなど）をDBで管理すること

### 2.2 デバイス情報取得
- Matterプロトコル経由でデバイスの属性情報や状態を取得できること
- デバイスのエンドポイントやクラスタ情報も取得できること

### 2.3 コマンド実行
- WebSocketまたはREST API経由でMatterデバイスにコマンドを送信できること
- コマンドの実行結果をクライアントに返却できること

### 2.4 MQTT連携
- デバイス情報や状態をMQTTでpublishできること
- MQTT経由でデバイス制御コマンドを受信し、Matterデバイスへ反映できること
- Homie規格に準拠したトピック構造でpublishすること

### 2.5 サブスクリプション
- デバイスの属性値変化をMatterプロトコルでサブスクライブし、変化時にMQTTやWebSocketで通知できること

### 2.6 設定管理
- 各種パスやブローカーURLなどの設定値は環境変数または設定ファイルで管理できること

---

## 3. クラス設計要件

### 3.1 クラス分割の方針
- 各機能ごとに責任を明確に分離したクラス設計とすること
- グローバル変数の使用を避け、状態はクラスインスタンスで管理すること

### 3.2 主要クラス案

#### 3.2.1 Database（データベース管理）
- デバイス情報やユニークIDのCRUD操作を担当
- SQLiteを利用し、テーブルスキーマの自動作成も行う

#### 3.2.2 MQTTInterface（MQTT連携）
- MQTTブローカーとの接続・切断・publish/subscribeを管理
- Homie規格に準拠したトピック構造でデータをやり取りする
- デバイス状態のMQTT通知や、MQTT経由のコマンド受信を担当

#### 3.2.3 ChipToolManager（Matterコマンド管理）
- Matter CLIツールのREPLプロセス管理
- コマンド送信・レスポンス受信・パース処理を担当

#### 3.2.4 SubscriptionManager（サブスクリプション管理）
- デバイス属性のサブスクリプション管理
- 属性変化時の通知処理

#### 3.2.5 WebSocketInterface（WebSocket管理）
- WebSocketクライアントの接続管理
- 全クライアントへのブロードキャスト送信

#### 3.2.6 APIInterface（API管理）
- REST APIのエンドポイント管理・ルーティング・バリデーション等を担当
- 外部クライアントからのリクエストを受け付け、各種サービスクラスと連携する

#### 3.2.7 Config（設定管理）
- 環境変数や設定ファイルから各種パス・URL等を取得

#### 3.2.8 DeviceManager（デバイス管理）
- デバイスの論理的な管理・操作を担当

---

## 4. 非機能要件

### 4.1 ログ出力
- 主要な処理・エラーはログとして出力されること

### 4.2 拡張性・保守性
- クラス分割や関数分割により、機能追加や修正が容易であること

### 4.3 エラーハンドリング
- 例外発生時は適切にログ出力し、システムが落ちないようにすること

### 4.4 テスト容易性
- 各機能はユニットテスト可能な構造であること

---

## 5. インターフェース要件

### 5.1 REST API
- `/command`エンドポイントでコマンド送信ができること

### 5.2 WebSocket
- `/ws`エンドポイントでリアルタイム通信ができること

### 5.3 MQTT
- Homie規格に準拠したトピックでpublish/subscribeできること

---

## 6. データベース要件
- SQLiteを利用し、Device/UniqueIDテーブルを持つこと
- テーブルスキーマは初回起動時に自動作成されること

---

## 7. 環境要件
- Python 3.8以上
- 必要なパッケージは`requirements.txt`で管理

---

## 8. その他
- 既存の関数型実装からクラスベース実装へのリファクタリングを推奨
- クラス間の依存関係は明確にし、疎結合を意識すること 